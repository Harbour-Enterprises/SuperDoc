<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="./file-upload.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SuperDoc - CDN example</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .title {
      font-size: 18px;
    }
  </style>
</head>
<body>

  <div class="title">SuperDoc - CDN example</div>
  
  <div style="margin: 20px 0;">
    <label for="version-select">Version: </label>
    <select id="version-select">
      <option value="0.11.45">Loading versions...</option>
    </select>
  </div>
  
  <div id="my-toolbar"></div>

  <button class="file-upload-button">Load Document</button>
  <input class="file-upload-input" style="display: none;" type="file" accept=".docx">

  <div id="superdoc"></div>

  <script type="module">
    let currentSuperDoc = null;
    let lastUploadedDocument = null;
    let isInitialized = false;
    
    const config = {
      selector: '#superdoc',
      toolbar: '#my-toolbar',
      documentMode: 'editing',
      pagination: true,
      rulers: true,
      onReady: (event) => {
        console.log('SuperDoc is ready', event);
        isInitialized = true;
      },
      onEditorCreate: (event) => {
        console.log('Editor is created', event);
      },
    };

    async function fetchVersions() {
      try {
        const response = await fetch('https://registry.npmjs.org/@harbour-enterprises/superdoc');
        const data = await response.json();
        return Object.keys(data.versions).reverse(); // Latest first
      } catch (error) {
        console.error('Error fetching versions:', error);
        return ['0.11.45']; // Fallback
      }
    }

    async function loadSuperDocVersion(version) {
      return new Promise((resolve, reject) => {
        // Remove existing scripts
        const existingScript = document.querySelector('script[src*="superdoc.umd.js"]');
        const existingStyle = document.querySelector('link[href*="style.css"]');
        
        if (existingScript) existingScript.remove();
        if (existingStyle) existingStyle.remove();
        
        // Load new CSS
        const style = document.createElement('link');
        style.rel = 'stylesheet';
        style.href = `https://unpkg.com/@harbour-enterprises/superdoc@${version}/dist/style.css`;
        document.head.appendChild(style);
        
        // Load new JS
        const script = document.createElement('script');
        script.type = 'module';
        script.src = `https://unpkg.com/@harbour-enterprises/superdoc@${version}/dist/superdoc.umd.js`;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    async function initializeSuperDoc() {
      if (currentSuperDoc) {
        try {
          currentSuperDoc.destroy();
        } catch (e) {
          console.log('Error destroying previous instance:', e);
        }
      }
      
      const docConfig = {...config};
      if (lastUploadedDocument) {
        docConfig.document = lastUploadedDocument;
      }
      
      currentSuperDoc = new SuperDocLibrary.SuperDoc(docConfig);
    }

    async function switchVersion(version) {
      try {
        await loadSuperDocVersion(version);
        // Small delay to ensure the library is fully loaded
        setTimeout(() => {
          initializeSuperDoc();
        }, 100);
      } catch (error) {
        console.error('Error switching version:', error);
      }
    }

    async function init() {
      const versions = await fetchVersions();
      const select = document.getElementById('version-select');
      
      select.innerHTML = '';
      versions.forEach(version => {
        const option = document.createElement('option');
        option.value = version;
        option.textContent = version;
        select.appendChild(option);
      });
      
      // Set default version
      select.value = '0.11.45';
      
      // Initialize SuperDoc with default version
      initializeSuperDoc();
      
      // Handle version changes
      select.addEventListener('change', (e) => {
        switchVersion(e.target.value);
      });
    }

    // Handle file uploads
    window.addEventListener('file-upload', (event) => {
      lastUploadedDocument = event.detail;
      if (isInitialized) {
        initializeSuperDoc();
      }
    });

    // Initialize when page loads
    init();
  </script>
  <script type="module" src="./file-upload.js"></script>

</body>
</html>
