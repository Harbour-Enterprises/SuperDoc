var pe=Object.defineProperty;var me=(n,e)=>{for(var t in e)pe(n,t,{get:e[t],enumerable:!0})};function v(n,e){return!!n?.trim()}function T(n,e,t=!1){try{let r=n.trim();return r=fe(r),JSON.parse(r)}catch(r){return t&&console.error("[AIActions] Failed to parse JSON:",{original:n,error:r instanceof Error?r.message:"Unknown error"}),e}}function fe(n){let e=n.trim();if(e.startsWith("```")&&e.endsWith("```")){let t=3,r=e.indexOf(`
`,t);if(r!==-1)t=r+1;else{let s=e.substring(3).match(/^(?:json|javascript|typescript|js|ts)/);s&&(t=3+s[0].length)}let o=e.lastIndexOf("```");if(o>t)return e.substring(t,o).trim()}return n}function q(n){return`${n}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}import{TextSelection as he}from"prosemirror-state";var ge="#6CA0DC",A=class{constructor(e){this.editor=e}findResults(e){if(!e?.length)return[];let r=this.editor?.view?.state?.selection,s=r&&!r.empty&&typeof r.from=="number"&&typeof r.to=="number"?{from:r.from,to:r.to}:null;return e.map(i=>{let l=i.originalText,c=(this.editor.commands?.search?.(l)??[]).map(u=>{let d=u.from,m=u.to;return typeof d!="number"||typeof m!="number"?null:{from:d,to:m}}).filter(u=>u!==null);return s&&(c=c.filter(u=>u.from<s.to&&u.to>s.from)),{...i,positions:c}}).filter(i=>i.positions.length>0)}createHighlight(e,t,r=ge){this.editor.chain().setTextSelection({from:e,to:t}).setHighlight(r).run(),this.scrollToPosition(e,t)}scrollToPosition(e,t){let{state:r,view:o}=this.editor;if(!r||!o)return;let s=r.tr.setSelection(he.create(r.doc,e,t)).scrollIntoView();o.dispatch(s)}getSelectionRange(){let{state:e}=this.editor;if(!e)return null;let{from:t,to:r}=e.selection;return typeof t!="number"||typeof r!="number"?null:{from:t,to:r}}collectTextSegments(e,t){let{state:r}=this.editor,o=[];if(!r?.doc)return o;let s=r.doc.content.size;return e<0||t>s||e>t||r.doc.nodesBetween(e,t,(i,l)=>{if(!i.isText)return!0;let a=typeof i.text=="string"?i.text:"",c=Math.max(e,l),u=Math.min(t,l+i.nodeSize),d=Math.max(0,Math.min(a.length,c-l)),m=Math.max(0,Math.min(a.length,u-l)),f=Math.max(0,m-d);return f===0||o.push({length:f,marks:i.marks.map(g=>g)}),!0}),o}getMarksAtPosition(e){let{state:t}=this.editor;if(!t?.doc)return[];let r=t.doc.content.size;return e<0||e>r?[]:t.storedMarks?[...t.storedMarks]:t.doc.resolve(e).marks()}buildTextNodes(e,t,r,o){if(!r)return[];let{state:s}=this.editor;if(!s)return[];let i=o??this.collectTextSegments(e,t),l=s.schema;if(!i.length)return[l.text(r,this.getMarksAtPosition(e))];let a=[],c=0;for(let u of i){if(c>=r.length)break;let d=Math.min(u.length,r.length-c);if(!d)continue;let m=r.slice(c,c+d);a.push(l.text(m,u.marks)),c+=d}if(c<r.length){let u=i[i.length-1].marks;a.push(l.text(r.slice(c),u))}return a}computeChangeRange(e,t){let r=e.length,o=t.length,s=0;for(;s<r&&s<o&&e[s]===t[s];)s++;if(s===r&&s===o)return{prefix:s,suffix:0,hasChange:!1};let i=0;for(;i<r-s&&i<o-s&&e[r-1-i]===t[o-1-i];)i++;return{prefix:s,suffix:i,hasChange:!0}}applyPatch(e,t,r){let{state:o,view:s}=this.editor;if(!o||!s)return;let i=o.doc.content.size;if(e<0||t>i||e>t)return;let l=o.doc.textBetween(e,t,"",""),{prefix:a,suffix:c,hasChange:u}=this.computeChangeRange(l,r);if(!u)return;let d=e+a,m=t-c,f=Math.max(a,r.length-c),g=r.slice(a,f),y=this.collectTextSegments(d,m),p=this.buildTextNodes(d,m,g,y),h=o.tr.delete(d,m),x=d;for(let C of p)h.insert(x,C),x+=C.nodeSize;s.dispatch(h)}replaceText(e,t,r){this.applyPatch(e,t,r)}createTrackedChange(e,t,r){let o=q("tracked-change");return this.editor.commands.enableTrackChanges(),this.applyPatch(e,t,r),this.editor.commands.disableTrackChanges(),o}async createComment(e,t,r){let o=q("comment");this.editor.commands.enableTrackChanges();try{this.editor.chain().setTextSelection({from:e,to:t}).insertComment({commentText:r}).run()}finally{this.editor.commands.disableTrackChanges()}return o}insertText(e){let t=this.getSelectionRange();t&&this.applyPatch(t.from,t.to,e)}};var w={SEARCH:"You are a document search assistant. Always respond with valid JSON.",EDIT:"You are a document editing assistant. Always respond with valid JSON.",SUMMARY:"You are a document summarization assistant. Always respond with valid JSON.",CONTENT_GENERATION:"You are a document content generation assistant. Always respond with valid JSON."},G=(n,e,t)=>`apply this query for original text return the EXACT text from the doc no title or added text: ${n}, ${t?"ALL occurrences":"FIRST occurrence ONLY"}
            Document context:
            ${e}
            
            Respond with JSON:
            {
              "success": boolean,
              "results": [ { 
                  "originalText": string,
                }
              ]
            }`,K=(n,e,t)=>`${`apply this query: ${n} if find and replace query then Find and replace the EXACT text of ${t?"ALL occurrences":"FIRST occurrence ONLY"}`}
            Document context:
            ${e}
            
            Respond with JSON:
            {
              "success": boolean,
              "results": [{
                  "originalText": string,
                  "suggestedText": string,
              }],
            }`,X=(n,e)=>`${n}
            Document context:
            ${e}
            
            Respond with JSON:
            {
              "success": boolean,
              "results": [ { 
                  "suggestedText": string,
                }
              ]
            }`,Z=(n,e)=>`${n}
            ${e?`Current document:
${e}
`:""}
            Respond with JSON: { 
                "success": boolean, "results": [ { 
                "suggestedText": string,
                }
            ]`;var R=class{constructor(e,t,r,o=!1,s,i){this.provider=e;this.editor=t;this.documentContextProvider=r;this.enableLogging=o;this.onStreamChunk=s;this.streamPreference=i;if(this.adapter=new A(this.editor),!this.adapter)throw new Error("SuperDoc editor is not available; retry once the editor is initialized");typeof this.provider.streamResults=="boolean"&&(this.streamPreference=this.provider.streamResults)}getDocumentContext(){if(!this.documentContextProvider)return"";try{return this.documentContextProvider()}catch(e){return this.enableLogging&&console.error(`Failed to retrieve document context: ${e instanceof Error?e.message:"Unknown error"}`),""}}async executeFindQuery(e,t){if(!v(e,"Query"))throw new Error("Query cannot be empty");let r=this.getDocumentContext();if(!r)return{success:!1,results:[]};let o=G(e,r,t),s=await this.runCompletion([{role:"system",content:w.SEARCH},{role:"user",content:o}]),i=T(s,{success:!1,results:[]},this.enableLogging);return!i.success||!i.results||(i.results=this.adapter.findResults(i.results)),i}async find(e){let t=await this.executeFindQuery(e,!1);if(t.success&&t.results?.length){t.results=[t.results[0]];let r=t.results[0];if(r?.positions&&r.positions.length>0){let{from:o,to:s}=r.positions[0];this.adapter.scrollToPosition(o,s)}}return t}async findAll(e){return this.executeFindQuery(e,!0)}async highlight(e,t="#6CA0DC"){let r=await this.find(e);if(!r.success)return{...r,success:!1};try{let o=r.results?.find(s=>s.positions&&s.positions.length>0);return!o||!o.positions||!o.positions.length?{success:!1,results:[]}:(this.adapter.createHighlight(o.positions[0].from,o.positions[0].to,t),{results:[o],success:!0})}catch(o){throw this.enableLogging&&console.error(`Failed to highlight: ${o instanceof Error?o.message:"Unknown error"}`),o}}async executeOperation(e,t,r){let o=this.getDocumentContext();if(!o)return[];let s=K(e,o,t),i=await this.runCompletion([{role:"system",content:w.EDIT},{role:"user",content:s}]),a=T(i,{success:!1,results:[]},this.enableLogging).results||[];if(!a.length)return[];let c=this.adapter.findResults(a),u=c?.[0];for(let d of c)try{if(!d.positions||!d.positions.length)return[];if(await r(this.adapter,d.positions[0],d),!t)return[u]}catch(m){throw this.enableLogging&&console.error(`Failed to execute operation: ${m instanceof Error?m.message:"Unknown"}`),m}return c}async replace(e){if(!v(e,"Query"))throw new Error("Query cannot be empty");let t=await this.executeOperation(e,!1,(r,o,s)=>(r.replaceText(o.from,o.to,s?.suggestedText||""),Promise.resolve()));return{success:t.length>0,results:t}}async replaceAll(e){if(!v(e,"Query"))throw new Error("Query cannot be empty");let t=await this.executeOperation(e,!0,(r,o,s)=>(r.replaceText(o.from,o.to,s?.suggestedText||""),Promise.resolve()));return{success:t.length>0,results:t}}async insertTrackedChange(e){if(!v(e,"Query"))throw new Error("Query cannot be empty");return{success:!0,results:await this.executeOperation(e,!1,(r,o,s)=>{let i=r.createTrackedChange(o.from,o.to,s.suggestedText||"");return Promise.resolve(i)})}}async insertTrackedChanges(e){if(!v(e,"query"))throw new Error("Query cannot be empty");return{success:!0,results:await this.executeOperation(e,!0,(r,o,s)=>{let i=r.createTrackedChange(o.from,o.to,s.suggestedText||"");return Promise.resolve(i)})}}async insertComment(e){if(!v(e,"Query"))throw new Error("Query cannot be empty");return{success:!0,results:await this.executeOperation(e,!1,(r,o,s)=>r.createComment(o.from,o.to,s.suggestedText||""))}}async insertComments(e){if(!v(e,"Query"))throw new Error("Query cannot be empty");return{success:!0,results:await this.executeOperation(e,!0,(r,o,s)=>r.createComment(o.from,o.to,s.suggestedText||""))}}async summarize(e){let t=this.getDocumentContext();if(!t)return{results:[],success:!1};let r=X(e,t),o=this.streamPreference!==!1,s=0,i=await this.runCompletion([{role:"system",content:w.SUMMARY},{role:"user",content:r}],o),l=T(i,{results:[],success:!1},this.enableLogging),a=l.results?.[0]?.suggestedText;return a&&(!o||a.length>s)&&this.onStreamChunk?.(a),l}async insertContent(e){if(!v(e,"query"))throw new Error("Query cannot be empty");if(!this.adapter)return{success:!1,results:[]};let t=this.getDocumentContext(),r=Z(e,t),o=this.streamPreference!==!1,s=0,i=await this.runCompletion([{role:"system",content:w.CONTENT_GENERATION},{role:"user",content:r}],o,async a=>{let c=ye(a);if(!c?.available)return!1;if(this.onStreamChunk?.(c.text),c.text.length>s){let u=c.text.slice(s);s=c.text.length,u&&await this.adapter.insertText(u)}return!0}),l=T(i,{success:!1,results:[]},this.enableLogging);if(!l.success||!l.results)return{success:!1,results:[]};try{let a=l.results[0];if(!a||!a.suggestedText)return{success:!1,results:[]};if(o){let c=a.suggestedText;s<c.length&&await this.adapter.insertText(c.slice(s)),this.onStreamChunk?.(c)}else await this.adapter.insertText(a.suggestedText),this.onStreamChunk?.(a.suggestedText);return{success:!0,results:[a]}}catch(a){throw this.enableLogging&&console.error(`Failed to insert: ${a instanceof Error?a.message:"Unknown error"}`),a}}async runCompletion(e,t=!1,r){if(!t)return this.provider.getCompletion(e);let o="",s=!1;try{let l=this.provider.streamCompletion(e);for await(let a of l){if(s=!0,!a)continue;o+=a;let c=!1;r&&(c=!!await r(o,a)),c||this.onStreamChunk?.(o)}}catch(l){if(!o)return this.provider.getCompletion(e);throw l}if(!s||!o)return this.provider.getCompletion(e);let i=o.trim();return!i||!i.startsWith("{")&&!i.startsWith("[")?this.provider.getCompletion(e):o}};function ye(n){let e='"suggestedText"',t=n.lastIndexOf(e);if(t===-1)return null;let r=t+e.length,o=!1;for(;r<n.length;){let c=n[r];if(c===":"){o=!0,r++;break}if(!ee(c))return{text:"",complete:!1,available:!1};r++}if(!o)return{text:"",complete:!1,available:!1};for(;r<n.length&&ee(n[r]);)r++;if(r>=n.length)return{text:"",complete:!1,available:!1};if(n[r]!=='"')return{text:"",complete:!1,available:!1};r++;let s="",i=!1,l=!1,a=r;for(;a<n.length;){let c=n[a];if(i){if(c==="n")s+=`
`,a++;else if(c==="r")s+="\r",a++;else if(c==="t")s+="	",a++;else if(c==='"')s+='"',a++;else if(c==="\\")s+="\\",a++;else if(c==="u"){let u=n.slice(a+1,a+5);if(u.length<4||!/^[0-9a-fA-F]{4}$/.test(u))return{text:s,complete:!1,available:!0};s+=String.fromCharCode(parseInt(u,16)),a+=5}else s+=c,a++;i=!1;continue}if(c==="\\"){i=!0,a++;continue}if(c==='"'){l=!0;break}s+=c,a++}return i?{text:s,complete:!1,available:!0}:{text:s,complete:l,available:!0}}function ee(n){return n===" "||n===`
`||n==="\r"||n==="	"}function z(n){if(!n||typeof n!="object")return!1;let e=n;return typeof e.getCompletion=="function"&&typeof e.streamCompletion=="function"}function te(n){if(z(n))return n;switch(n.type){case"openai":return xe(n);case"anthropic":return Ce(n);case"http":return H(n);default:throw new Error("Unsupported AI provider type")}}function H(n){let{url:e,streamUrl:t,headers:r={},method:o="POST",fetch:s,buildRequestBody:i,parseCompletion:l=_,parseStreamChunk:a=Ae,temperature:c,maxTokens:u,stop:d,streamResults:m}=n,f=we(s),g=i??(p=>W({messages:p.messages,stream:p.options?.stream??p.stream??m,temperature:p.options?.temperature??c,max_tokens:p.options?.maxTokens??u,stop:p.options?.stop??d,model:p.options?.model,...p.options?.providerOptions}));async function y(p,h){let x=h.options?.stream??h.stream??m,C=g(h),ue=!!(i&&x&&C&&typeof C=="object"&&!Array.isArray(C)&&!("stream"in C))?{...C,stream:!0}:C,S=await f(p,{method:o,headers:Re(r),body:JSON.stringify(ue),signal:h.options?.signal});if(!S.ok){let de=await j(S);throw new Error(`AI provider request failed with status ${S.status} (${S.statusText}): ${de}`)}return S}return{streamResults:m,async*streamCompletion(p,h){let x=t??e;if(!x){let P=await this.getCompletion(p,h);P&&(yield P);return}let C=await y(x,{messages:p,stream:!0,options:h});yield*be(C,a,l)},async getCompletion(p,h){let x=await y(e,{messages:p,stream:!1,options:h});return Pe(x,l)}}}function xe(n){let{apiKey:e,baseURL:t="https://api.openai.com/v1",model:r,organizationId:o,headers:s,completionPath:i="/chat/completions",requestOptions:l,fetch:a,temperature:c,maxTokens:u,stop:d,streamResults:m}=n,f=ie(t,i),g={"Content-Type":"application/json",Authorization:`Bearer ${e}`,...o?{"OpenAI-Organization":o}:{},...s};return H({type:"http",url:f,streamUrl:f,headers:g,fetch:a,temperature:c,maxTokens:u,stop:d,streamResults:m,buildRequestBody:({messages:y,stream:p,options:h})=>W({model:h?.model??r,temperature:h?.temperature??c,max_tokens:h?.maxTokens??u,stop:h?.stop??d,stream:h?.stream??p??m,messages:y,...l,...h?.providerOptions}),parseCompletion:Se,parseStreamChunk:ne})}function Ce(n){let{apiKey:e,baseURL:t="https://api.anthropic.com",apiVersion:r="2023-06-01",model:o,headers:s,requestOptions:i,fetch:l,temperature:a,maxTokens:c=1024,stop:u,streamResults:d}=n,m=ie(t,"/v1/messages"),f={"Content-Type":"application/json","x-api-key":e,"anthropic-version":r,...s};return H({type:"http",url:m,streamUrl:m,headers:f,fetch:l,temperature:a,maxTokens:c,stop:u,streamResults:d,buildRequestBody:({messages:g,stream:y,options:p})=>{let{system:h,anthropicMessages:x}=Te(g);return W({model:p?.model??o,temperature:p?.temperature??a,max_tokens:p?.maxTokens??c,stop_sequences:p?.stop??u,stream:p?.stream??y??d,system:h,messages:x,...i,...p?.providerOptions})},parseCompletion:oe,parseStreamChunk:se})}async function*be(n,e,t){if(!n.ok)throw new Error(`AI provider stream failed with status ${n.status}: ${await j(n)}`);if(!n.body){let i=await j(n);i&&(yield*J(i,e,t));return}let r=n.body.getReader(),o=new TextDecoder,s="";try{for(;;){let{done:i,value:l}=await r.read();if(i)break;s+=o.decode(l,{stream:!0});let a=s.split(`

`);s=a.pop()||"";for(let c of a)yield*J(c,e,t)}s.trim()&&(yield*J(s,e,t))}finally{r.releaseLock()}}function*J(n,e,t){for(let r of ve(n)){if(r==="[DONE]")return;let o=r;try{o=JSON.parse(r)}catch{}let s=e(o)??(typeof o=="string"?o:t(o));s&&(yield s)}}async function j(n){try{return await n.text()}catch{return""}}function ve(n){let e=n.split(`
`).map(r=>r.trim()).filter(Boolean),t=[];for(let r of e)r.startsWith("data:")?t.push(r.slice(5).trim()):t.push(r);return t}async function Pe(n,e){if((n.headers.get("content-type")??"").includes("application/json")){let r=await n.json(),o=e(r);return o.length>0?o:JSON.stringify(r)}return await n.text()}function b(n){return typeof n=="object"&&n!==null&&!Array.isArray(n)}function re(n){return b(n)?"text"in n&&n.text!=null?[String(n.text)]:"content"in n&&Array.isArray(n.content)?n.content.map(e=>typeof e=="string"?e:b(e)&&"text"in e&&e.text!=null?String(e.text):"").filter(Boolean):[]:[]}function _(n){if(typeof n=="string")return n;if(!b(n))return"";if("choices"in n&&Array.isArray(n.choices)&&n.choices.length>0){let e=n.choices[0];if(b(e)){if("message"in e&&b(e.message)&&"content"in e.message)return String(e.message.content||"");if("text"in e)return String(e.text||"")}}if("content"in n){let{content:e}=n;if(typeof e=="string")return e;if(Array.isArray(e))return e.flatMap(t=>re(t)).join("")}return JSON.stringify(n)}function Se(n){if(b(n)&&"choices"in n&&Array.isArray(n.choices)&&n.choices.length>0){let e=n.choices[0];if(b(e)&&"message"in e&&b(e.message)&&"content"in e.message)return String(e.message.content||"")}return _(n)}function ne(n){if(b(n)&&"choices"in n&&Array.isArray(n.choices))return n.choices.map(e=>{if(!b(e)||!("delta"in e))return"";let t=e.delta;return b(t)?"content"in t?String(t.content||""):"text"in t?String(t.text||""):"":""}).join("")}function Te(n){let e=[],t=[];for(let r of n){if(r.role==="system"){t.push(r.content);continue}e.push({role:r.role,content:[{type:"text",text:r.content}]})}return{system:t.length?t.join(`
`):void 0,anthropicMessages:e}}function oe(n){return!b(n)||!("content"in n)||!Array.isArray(n.content)?_(n):n.content.flatMap(e=>re(e)).join("")}function se(n){if(b(n)){if("type"in n&&(n.type==="content_block_delta"||n.type==="message_delta")&&"delta"in n&&b(n.delta)&&"text"in n.delta)return String(n.delta.text);if("type"in n&&n.type==="message_start"&&"message"in n)return oe(n.message)}}function Ae(n){if(!(!n||typeof n!="object"))return ne(n)??se(n)}function we(n){if(n)return n;if(!globalThis?.fetch)throw new Error("No fetch available. Provide fetch in provider config.");return globalThis.fetch.bind(globalThis)}function Re(n){return Object.keys(n).some(e=>e.toLowerCase()==="content-type")?n:{...n,"Content-Type":"application/json"}}function W(n){return Object.fromEntries(Object.entries(n).filter(e=>e[1]!==void 0))}function ie(n,e){let t=n;for(;t.endsWith("/");)t=t.slice(0,-1);return`${t}${e.startsWith("/")?e:`/${e}`}`}var B=class{constructor(e,t){this.isReady=!1;this.initializationPromise=null;this.action={find:async e=>this.executeActionWithCallbacks(()=>this.commands.find(e)),findAll:async e=>this.executeActionWithCallbacks(()=>this.commands.findAll(e)),highlight:async(e,t)=>this.executeActionWithCallbacks(()=>this.commands.highlight(e,t)),replace:async e=>this.executeActionWithCallbacks(()=>this.commands.replace(e)),replaceAll:async e=>this.executeActionWithCallbacks(()=>this.commands.replaceAll(e)),insertTrackedChange:async e=>this.executeActionWithCallbacks(()=>this.commands.insertTrackedChange(e)),insertTrackedChanges:async e=>this.executeActionWithCallbacks(()=>this.commands.insertTrackedChanges(e)),insertComment:async e=>this.executeActionWithCallbacks(()=>this.commands.insertComment(e)),insertComments:async e=>this.executeActionWithCallbacks(()=>this.commands.insertComments(e)),summarize:async e=>this.executeActionWithCallbacks(()=>this.commands.summarize(e)),insertContent:async e=>this.executeActionWithCallbacks(()=>this.commands.insertContent(e))};this.superdoc=e;let{onReady:r,onStreamingStart:o,onStreamingPartialResult:s,onStreamingEnd:i,onError:l,provider:a,...c}=t,u=a.streamResults,d=z(a)?a:te(a);this.config={systemPrompt:this.getDefaultSystemPrompt(),enableLogging:!1,...c,provider:d},this.callbacks={onReady:r,onStreamingStart:o,onStreamingPartialResult:s,onStreamingEnd:i,onError:l};let m=this.getEditor();if(!m)throw new Error("AIActions requires an active editor before initialization");m.setOptions({user:{id:this.config.user.userId,name:this.config.user.displayName,image:this.config.user.profileUrl}}),this.commands=new R(this.config.provider,m,()=>this.getDocumentContext(),this.config.enableLogging,f=>this.callbacks.onStreamingPartialResult?.({partialResult:f}),u),this.initializationPromise=this.initialize()}async initialize(){try{this.isProviderAvailable(),this.isReady=!0,this.callbacks.onReady?.({aiActions:this})}catch(e){throw this.handleError(e),e}finally{this.initializationPromise=null}}isProviderAvailable(){if(!this.config.provider)throw new Error("AI provider is required")}async executeActionWithCallbacks(e){if(!this.getEditor())throw new Error("No active SuperDoc editor available for AI actions");try{this.callbacks.onStreamingStart?.();let r=await e();return this.callbacks.onStreamingEnd?.({fullResult:r}),r}catch(r){throw this.handleError(r),r}}getDefaultSystemPrompt(){return`You are an AI assistant integrated with SuperDoc, a document collaboration platform.
                Your role is to help users find, analyze, and understand document content.
                When searching for content, provide precise locations and relevant context.`}async waitUntilReady(){this.isReady||this.initializationPromise&&await this.initializationPromise}getIsReady(){return this.isReady}async streamCompletion(e,t){if(!this.isReady)throw new Error("AIActions is not ready yet. Call waitUntilReady() first.");let r=this.getDocumentContext(),o=r?`${e}

Document context:
${r}`:e,s=[{role:"system",content:this.config.systemPrompt||""},{role:"user",content:o}],i="";try{this.callbacks.onStreamingStart?.();let l=this.config.provider.streamCompletion(s,t);for await(let a of l)i+=a,this.callbacks.onStreamingPartialResult?.({partialResult:i});return this.callbacks.onStreamingEnd?.({fullResult:i}),i}catch(l){throw this.handleError(l),l}}async getCompletion(e,t){if(!this.isReady)throw new Error("AIActions is not ready yet. Call waitUntilReady() first.");let r=this.getDocumentContext(),o=r?`${e}

Document context:
${r}`:e,s=[{role:"system",content:this.config.systemPrompt||""},{role:"user",content:o}];try{return await this.config.provider.getCompletion(s,t)}catch(i){throw this.handleError(i),i}}getDocumentContext(){let e=this.getEditor();if(!e||!e.view?.state)return"";let{state:t}=e.view,{selection:r,doc:o}=t;return o?r&&!r.empty&&typeof r.from=="number"&&typeof r.to=="number"?o.textBetween(r.from,r.to," ").trim()||"":o.textContent?.trim()||"":""}handleError(e){this.config.enableLogging&&console.error("[AIActions Error]:",e),this.callbacks.onError?.(e)}getEditor(){return this.superdoc?.activeEditor??null}};var le={};me(le,{ALL_TOOLS:()=>Q,CONTENT_SCHEMA:()=>M,anthropicToolDefinitions:()=>ae,anthropicTools:()=>k,executeTool:()=>Y,getContentSchema:()=>D,getDocumentContext:()=>ce,getDocumentOutline:()=>L,getTool:()=>V,getToolNames:()=>Ee,insertContent:()=>$,readContent:()=>I,readSection:()=>U,readSelection:()=>E,replaceContent:()=>F,searchContent:()=>O});var E={name:"readSelection",description:"Read the currently selected content in the document. Returns the selection range (from/to positions) and the JSON representation. Use withContext to include surrounding paragraphs.",category:"read",async execute(n,e){try{let{state:t}=n;if(!t)return{success:!1,error:"Editor state not available",docChanged:!1};let{from:r,to:o}=t.selection,s=t.doc.cut(r,o),i=t.doc,l={from:r,to:o,content:s.toJSON()},a=e?.withContext;if(a&&a>0){let c=[];i.nodesBetween(0,r,(d,m)=>(d.type.name==="paragraph"&&c.push({position:m,content:d.toJSON()}),!0)),l.before=c.slice(-a).map(d=>d.content);let u=[];i.nodesBetween(o,i.content.size,(d,m)=>(d.type.name==="paragraph"&&u.length<a&&u.push(d.toJSON()),u.length<a)),l.after=u}return{success:!0,data:l,docChanged:!1,message:`Selection from position ${r} to ${o}${a?` with ${a} paragraphs context`:""}`}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error",docChanged:!1}}}};var I={name:"readContent",description:"Read document content at a specific position range (from/to character offsets). Use after searchContent to read actual content at found positions.",category:"read",async execute(n,e){try{let{from:t,to:r}=e;if(typeof t!="number"||typeof r!="number")return{success:!1,error:'Both "from" and "to" parameters must be numbers',docChanged:!1};if(t<0||r<t)return{success:!1,error:'Invalid range: "from" must be >= 0 and "to" must be >= "from"',docChanged:!1};let{state:o}=n;if(!o)return{success:!1,error:"Editor state not available",docChanged:!1};let s=o.doc.content.size,i=Math.min(t,s),l=Math.min(r,s),a=o.doc.cut(i,l);return{success:!0,data:{from:i,to:l,content:a.toJSON()},docChanged:!1,message:`Read content from position ${i} to ${l}`}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to read content",docChanged:!1}}}};var O={name:"searchContent",description:"Search for text or patterns in the document. Returns an array of matches with their positions (from/to character offsets). Use with readContent to see context or replaceContent to modify.",category:"read",async execute(n,e){try{let{query:t,caseSensitive:r=!1,regex:o=!1,findAll:s=!0}=e;if(!t)return{success:!1,error:"Query parameter is required",docChanged:!1};if(!n.commands?.search)return{success:!1,error:"Search command not available in editor",docChanged:!1};let i;if(o)try{i=new RegExp(t,r?"":"i")}catch(d){return{success:!1,error:`Invalid regular expression: ${d instanceof Error?d.message:"Unknown error"}`,docChanged:!1}}else i=t;let l=n.commands.search(i);if(!l||!Array.isArray(l))return{success:!1,error:"Search command returned invalid results",docChanged:!1};let a=l.map(d=>({text:d.text,from:d.from,to:d.to})),c=a;!o&&r&&(c=a.filter(d=>d.text===t));let u=s?c:c.slice(0,1);return{success:!0,data:{matches:u,count:u.length,query:t},docChanged:!1,message:`Found ${u.length} match(es) for "${t}"`}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Search failed",docChanged:!1}}}};var M={type:"array",description:"Array of paragraph nodes that make up the document content",items:{additionalProperties:!1,type:"object",required:["type","content"],properties:{type:{type:"string",const:"paragraph",description:'Paragraph node. For headings, use styleId attribute (e.g., "Heading1"). For lists, use numberingProperties.'},content:{type:"array",description:"Array of text nodes and line breaks",items:{oneOf:[{type:"object",required:["type","text"],properties:{type:{type:"string",const:"text",description:"Text content node"},text:{type:"string",description:"The actual text content"},marks:{type:"array",description:"Optional formatting marks (bold, italic, etc.)",items:{type:"object",required:["type"],properties:{type:{type:"string",enum:["bold","italic","underline","strike","link","highlight","textStyle"],description:"Type of formatting mark"},attrs:{type:"object",description:"Mark attributes (e.g., href for links, color for highlights)"}}}}}},{type:"object",required:["type"],properties:{type:{type:"string",const:"hardBreak",description:"Line break (Shift+Enter)"}}}]}},attrs:{type:"object",description:"Paragraph attributes for styling and structure",properties:{styleId:{type:"string",description:'Word style ID for headings (e.g., "Heading1", "Heading2", etc.) or other styles'},textAlign:{type:"string",enum:["left","center","right","justify"],description:"Text alignment"},lineHeight:{oneOf:[{type:"string"},{type:"number"}],description:'Line height (e.g., "1.5" or 1.5)'},textIndent:{oneOf:[{type:"string"},{type:"number"}],description:"First-line indentation"},numberingProperties:{type:"object",description:"List properties. Use numId=1 for bullet lists, numId=2 for numbered lists",required:["numId","ilvl"],properties:{numId:{type:"number",description:"Numbering definition ID: 1 for bullets, 2 for numbered lists"},ilvl:{type:"number",description:"Indentation level (0-8, where 0 is top level)"}}}}}}}};var D={name:"getContentSchema",description:"Get the JSON schema that describes the expected format for document content. Call this before using insertContent or replaceContent to understand how to structure the content array.",category:"read",async execute(n){return{success:!0,data:{schema:M,summary:'Content is an array of paragraph objects. Each paragraph has type="paragraph", optional attrs (styleId for headings, numberingProperties for lists), and content array of text nodes with optional marks (bold, italic, etc.).'},docChanged:!1,message:"Content schema returned. Use this format for insertContent and replaceContent."}}};var ke={after:null,before:null,line:null,lineRule:"auto"};function N(n){return Array.isArray(n)?n.map(e=>{if(e?.type!=="paragraph")return e;let t={...e};return t.attrs||(t.attrs={}),t.attrs.spacing||(t.attrs.spacing={...ke}),t}):n}var $={name:"insertContent",description:'Insert new content into the document. Position can be "selection" (at cursor), "documentStart", or "documentEnd". Content should be an array of paragraph blocks in ProseMirror JSON format.',category:"write",async execute(n,e){try{let{position:t,content:r}=e;if(!r||!Array.isArray(r))return{success:!1,error:"Content must be an array of nodes",docChanged:!1};let o=N(r),{state:s}=n;if(!s)return{success:!1,error:"Editor state not available",docChanged:!1};let i;switch(t){case"selection":i=s.selection.from;break;case"documentStart":i=0;break;case"documentEnd":i=s.doc.content.size;break;default:return{success:!1,error:`Invalid position: ${t}`,docChanged:!1}}let l;return Array.isArray(o)&&o.length===1?l=n.commands.insertContentAt(i,o[0]):l=n.commands.insertContentAt(i,o),l?{success:!0,data:{insertedAt:i},docChanged:!0,message:`Inserted ${o.length} node(s) at ${t}`}:{success:!1,error:"Failed to insert content",docChanged:!1}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error",docChanged:!1}}}};var F={name:"replaceContent",description:"Replace content in the document. Either provide a query to search and replace text, or specify exact from/to positions.",category:"write",async execute(n,e){try{let{query:t,from:r,to:o,content:s,replaceAll:i=!1}=e;if(!s||!Array.isArray(s))return{success:!1,error:"Content must be an array of nodes",docChanged:!1};let{state:l}=n;if(!l)return{success:!1,error:"Editor state not available",docChanged:!1};let a=N(s);if(t){if(!n.commands?.search)return{success:!1,error:"Search command not available in editor",docChanged:!1};let f=n.commands.search(t);if(!f||!Array.isArray(f)||f.length===0)return{success:!1,error:`No matches found for "${t}"`,docChanged:!1};let g=a;a.length===1&&a[0].type==="paragraph"&&Array.isArray(a[0].content)&&(g=a[0].content);let y=i?[...f].reverse():[f[0]],p=0;for(let h of y)n.commands.insertContentAt({from:h.from,to:h.to},g)&&p++;return{success:p>0,data:{replacedCount:p,totalMatches:f.length,query:t},docChanged:p>0,message:`Replaced ${p} of ${f.length} occurrence(s) of "${t}"`}}if(typeof r!="number"||typeof o!="number")return{success:!1,error:"Either query or from/to positions must be provided",docChanged:!1};if(r<0||o<r)return{success:!1,error:"Invalid range: from must be >= 0 and to must be >= from",docChanged:!1};let c=l.doc.content.size,u=Math.max(0,Math.min(r,c)),d=Math.max(0,Math.min(o,c));if(u===0&&d===c){let f=n.commands.setContent({type:"doc",content:a});return{success:f,data:{replacedRange:{from:u,to:d}},docChanged:f,message:f?"Replaced entire document":"Failed to replace document"}}return n.commands.insertContentAt({from:u,to:d},{type:"doc",content:a})?{success:!0,data:{replacedRange:{from:u,to:d}},docChanged:!0,message:`Replaced content from position ${u} to ${d}`}:{success:!1,error:"Failed to replace content",docChanged:!1}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error",docChanged:!1}}}};var L={name:"getDocumentOutline",description:"Get the document outline (headings and their positions). Use this to understand document structure before reading or editing specific sections.",category:"read",async execute(n){try{let{state:e}=n;if(!e)return{success:!1,error:"Editor state not available",docChanged:!1};let t=[],r=e.doc;return r.descendants((o,s)=>{if(o.type.name==="paragraph"){let i=o.attrs?.styleId;if(i&&typeof i=="string"){let l=i.match(/^Heading(\d)$/i);if(l){let a=parseInt(l[1],10),c="";o.content.forEach(u=>{u.isText&&(c+=u.text)}),t.push({text:c.trim()||"(untitled)",level:a,position:s})}}}return!0}),{success:!0,data:{headings:t,totalLength:r.content.size,headingCount:t.length},docChanged:!1,message:`Found ${t.length} headings in document`}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to get document outline",docChanged:!1}}}};var U={name:"readSection",description:"Read a specific section of the document by heading name or position range. Use heading parameter to find by name, or from/to for exact positions.",category:"read",async execute(n,e){try{let{heading:t,from:r,to:o}=e,{state:s}=n;if(!s)return{success:!1,error:"Editor state not available",docChanged:!1};let i=s.doc;if(typeof r=="number"&&typeof o=="number"){let g=Math.max(0,Math.min(r,i.content.size)),y=Math.max(g,Math.min(o,i.content.size)),p=i.cut(g,y);return{success:!0,data:{from:g,to:y,content:p.toJSON()},docChanged:!1,message:`Read section from position ${g} to ${y}`}}if(!t)return{success:!1,error:'Either "heading" or "from"/"to" parameters are required',docChanged:!1};let l=t.toLowerCase(),a=null,c=null,u=null,d=null;if(i.descendants((g,y)=>{if(g.type.name==="paragraph"){let p=g.attrs?.styleId;if(p&&typeof p=="string"){let h=p.match(/^Heading(\d)$/i);if(h){let x=parseInt(h[1],10),C="";if(g.content.forEach(P=>{P.isText&&(C+=P.text)}),a===null)C.toLowerCase().includes(l)&&(a=y,u=x,d=C.trim());else if(x<=u)return c=y,!1}}}return!0}),a===null)return{success:!1,error:`No heading found matching "${t}"`,docChanged:!1};let m=c??i.content.size,f=i.cut(a,m);return{success:!0,data:{heading:d,from:a,to:m,content:f.toJSON()},docChanged:!1,message:`Read section "${d}" (positions ${a}-${m})`}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to read section",docChanged:!1}}}};var Q={readSelection:E,readContent:I,searchContent:O,getContentSchema:D,insertContent:$,replaceContent:F,getDocumentOutline:L,readSection:U};function V(n){return Q[n]}function Ee(){return Object.keys(Q)}async function Y(n,e,t,r){try{if(r?.signal?.aborted)return{success:!1,error:"Tool execution was cancelled",docChanged:!1};let o=V(n);if(!o)return{success:!1,error:`Unknown tool: ${n}`,docChanged:!1};if(r?.validate&&e==null)return{success:!1,error:"Tool parameters are required",docChanged:!1};let s=await o.execute(t,e);return r?.onProgress&&r.onProgress(100),s}catch(o){return{success:!1,error:o instanceof Error?o.message:"Unknown error during tool execution",docChanged:!1}}}function k(n=[],e){let{enabledTools:t}=e||{},r=[{name:"readSelection",description:"Read the currently selected content in the document. Returns the selection range (from/to positions) and the JSON representation. Use withContext to include surrounding paragraphs.",input_schema:{type:"object",properties:{withContext:{type:"integer",description:"Number of paragraphs to include before and after the selection for context (optional)"}},required:[],additionalProperties:!1}},{name:"readContent",description:"Read document content at a specific position range (from/to character offsets). Use after searchContent to read actual content at found positions.",input_schema:{type:"object",properties:{from:{type:"integer",description:"Start position (character offset)"},to:{type:"integer",description:"End position (character offset)"}},required:["from","to"],additionalProperties:!1}},{name:"searchContent",description:"Search for text or patterns in the document. Returns matches with their positions (from/to character offsets). Use with readContent to see context or replaceContent to modify.",input_schema:{type:"object",properties:{query:{type:"string",description:"The text or pattern to search for"},caseSensitive:{type:"boolean",description:"Whether the search should be case-sensitive (default: false)"},regex:{type:"boolean",description:"Whether to treat query as a regular expression (default: false)"},findAll:{type:"boolean",description:"Whether to return all matches or just the first one (default: true)"}},required:["query"],additionalProperties:!1}},{name:"getContentSchema",description:"Get the JSON schema for document content format. Call this before insertContent or replaceContent to understand the expected structure for the content array.",input_schema:{type:"object",properties:{},required:[],additionalProperties:!1}},{name:"insertContent",description:'Insert new content into the document. Call getContentSchema first to understand the content format. Position can be "selection" (at cursor), "documentStart", or "documentEnd".',input_schema:{type:"object",properties:{position:{type:"string",enum:["selection","documentStart","documentEnd"],description:"Where to insert the content"},content:{type:"array",description:"Array of paragraph nodes. Call getContentSchema for the full format specification."}},required:["position","content"],additionalProperties:!1}},{name:"replaceContent",description:"Replace content in the document. Use query to search and replace text by name, or use from/to for exact positions.",input_schema:{type:"object",properties:{query:{type:"string",description:"Text to search for and replace. Use this instead of from/to positions."},from:{type:"integer",description:"Start position (character offset). Only needed if query is not provided."},to:{type:"integer",description:"End position (character offset). Only needed if query is not provided."},content:{type:"array",description:"Array of paragraph nodes to replace with."},replaceAll:{type:"boolean",description:"Whether to replace all occurrences when using query (default: false)"}},required:["content"],additionalProperties:!1}},{name:"getDocumentOutline",description:"Get the document outline (headings and their positions). Use this to understand document structure before reading or editing specific sections.",input_schema:{type:"object",properties:{},required:[],additionalProperties:!1}},{name:"readSection",description:"Read a specific section of the document by heading name or position range. Use heading parameter to find by name, or from/to for exact positions.",input_schema:{type:"object",properties:{heading:{type:"string",description:"Heading text to find and read (case-insensitive partial match). The section includes content until the next heading of same or higher level."},from:{type:"integer",description:"Start position (character offset). Alternative to heading parameter."},to:{type:"integer",description:"End position (character offset). Alternative to heading parameter."}},required:[],additionalProperties:!1}}];return t&&t.length>0?r.filter(o=>t.includes(o.name)):r}var ae=k;function ce(n,e){let t=e?.maxTokens??5e3,r=4,{state:o}=n;if(!o)return{strategy:"full",content:null};let s=o.doc.content.size;if(Math.ceil(s/r)<=t)return{strategy:"full",content:o.doc.toJSON()};let{from:l,to:a}=o.selection;return{strategy:"selection",content:o.doc.cut(l,a).toJSON(),message:"Document is large. Use searchContent to find text positions and readContent to read specific sections."}}import{SuperDoc as Dt}from"superdoc";export{B as AIActions,R as AIActionsService,le as AIBuilder,A as EditorAdapter,Dt as SuperDoc,k as anthropicTools,Y as executeTool,q as generateId,T as parseJSON,fe as removeMarkdownCodeBlocks,v as validateInput};
